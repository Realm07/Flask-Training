{% extends "base.html" %}

{% block title %}Add Password - Password Vault{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Password</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="service_name" class="form-label">Service Name *</label>
                            <input type="text" class="form-control" id="service_name" name="service_name" placeholder="e.g., Gmail, Facebook, Twitter" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">Category</label>
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">No Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username / Email *</label>
                            <input type="text" class="form-control" id="username" name="username" placeholder="your@email.com" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('password')">
                                    <i class="bi bi-eye" id="password-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#passwordGeneratorModal">
                                    <i class="bi bi-dice-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="url" class="form-label">Website URL</label>
                        <input type="url" class="form-control" id="url" name="url" placeholder="https://example.com">
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_favorite" name="is_favorite">
                        <label class="form-check-label" for="is_favorite">
                            <i class="bi bi-star"></i> Add to favorites
                        </label>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal -->
<div class="modal fade" id="passwordGeneratorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-dice-5"></i> Password Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="generatedPassword" class="form-label">Generated Password</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="generatedPassword" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="copyGeneratedPassword()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Length: <span id="lengthValue">16</span></label>
                    <input type="range" class="form-range" id="passwordLength" min="8" max="32" value="16">
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="useUppercase" checked>
                        <label class="form-check-label" for="useUppercase">A-Z</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="useLowercase" checked>
                        <label class="form-check-label" for="useLowercase">a-z</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="useDigits" checked>
                        <label class="form-check-label" for="useDigits">0-9</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="useSpecial" checked>
                        <label class="form-check-label" for="useSpecial">!@#$</label>
                    </div>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="excludeAmbiguous">
                    <label class="form-check-label" for="excludeAmbiguous">Exclude ambiguous (0, O, l, 1)</label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Strength: <span id="strengthLabel">-</span></label>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="useGeneratedPassword()">
                    <i class="bi bi-check-lg"></i> Use Password
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eye = document.getElementById(inputId + '-eye');
        if (input.type === 'password') {
            input.type = 'text';
            eye.classList.remove('bi-eye');
            eye.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            eye.classList.remove('bi-eye-slash');
            eye.classList.add('bi-eye');
        }
    }
    
    // Password Generator
    const lengthSlider = document.getElementById('passwordLength');
    const lengthValue = document.getElementById('lengthValue');
    const generatedPassword = document.getElementById('generatedPassword');
    const strengthLabel = document.getElementById('strengthLabel');
    const strengthBar = document.getElementById('strengthBar');
    
    lengthSlider.addEventListener('input', function() {
        lengthValue.textContent = this.value;
        generatePassword();
    });
    
    ['useUppercase', 'useLowercase', 'useDigits', 'useSpecial', 'excludeAmbiguous'].forEach(id => {
        document.getElementById(id).addEventListener('change', generatePassword);
    });
    
    function generatePassword() {
        const length = lengthSlider.value;
        const useUppercase = document.getElementById('useUppercase').checked;
        const useLowercase = document.getElementById('useLowercase').checked;
        const useDigits = document.getElementById('useDigits').checked;
        const useSpecial = document.getElementById('useSpecial').checked;
        const excludeAmbiguous = document.getElementById('excludeAmbiguous').checked;
        
        fetch(`/api/generate-password?length=${length}&uppercase=${useUppercase}&lowercase=${useLowercase}&digits=${useDigits}&special=${useSpecial}&exclude_ambiguous=${excludeAmbiguous}`)
            .then(response => response.json())
            .then(data => {
                generatedPassword.value = data.password;
                updateStrength(data.strength);
            });
    }
    
    function updateStrength(strength) {
        const colors = {
            'Very Weak': 'danger',
            'Weak': 'warning',
            'Medium': 'info',
            'Strong': 'primary',
            'Very Strong': 'success'
        };
        const color = colors[strength.strength] || 'secondary';
        strengthLabel.textContent = strength.strength;
        strengthLabel.className = 'text-' + color;
        strengthBar.className = 'progress-bar bg-' + color;
        strengthBar.style.width = strength.score + '%';
    }
    
    function copyGeneratedPassword() {
        navigator.clipboard.writeText(generatedPassword.value);
        alert('Password copied to clipboard!');
    }
    
    function useGeneratedPassword() {
        document.getElementById('password').value = generatedPassword.value;
        const modal = bootstrap.Modal.getInstance(document.getElementById('passwordGeneratorModal'));
        modal.hide();
    }
    
    // Generate initial password when modal opens
    document.getElementById('passwordGeneratorModal').addEventListener('shown.bs.modal', generatePassword);
</script>
{% endblock %}
